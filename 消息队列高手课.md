# 							消息队列高手课



## 消息队列概况



**学习消息队列，有哪些门槛？** 

基础技术知识和能力，例如： 

1. 熟练使用各种常用集合，比如：数组、链表、字典等； 
2. 掌握 Linux 系统的基础知识，会使用常用的命令；
3.  具备多线程、并发控制编程能力；
4. 编写过读写文件、通过网络收发数据的程序；
5. 能看懂最基本的 UML 图，包括类图、时序图等；
6. 了解最常用的几种设计模式和算法。

RocketMQ 官方文档： https://rocketmq.apache.org/docs/quick-start/ 

RocketMQ 中国开发者中心：http://rocketmq.cloud/zh-cn/ 

Kafka 官方文档： http://kafka.apache.org/documentation/

RabbitMQ 官方文档： https://www.rabbitmq.com/documentation.html 

![消息生态的全场景](C:\Users\tyrion\Desktop\notes\notes\消息生态的全场景.png)







## 一、MQ的使用场景

### 	MQ能解决什么问题

​		**我们使用mq主要是为了解决什么问题呢****

#### 		1,异步处理

​					对于某些业务无关的后续操作, 我们可以考虑使用mq来进行操作解耦

#### 	   2,流量控制

​					比如说秒杀业务这种,我们可以考虑直接将数据丢到mq, 避免请求直接打到服务后端

#### 		3,服务解耦

​			

### 	MQ会带来什么样的问题

1. 引入了mq会带来业务处理的时延问题
2. 增加了系统的复杂度,提高了维护成本和难度
3. 有可能产生数据不一致的问题



### 	应用场景

1. ​	原来系统的库存变动服务主要是通过mq为触发, 该部分的业务场景,确保库存数据能够不丢失即可,需求点:

   - 消息不丢失

   - 能够缓解数据库压力,避免风险

     数据库本身的时延问题是不存在问题,因为在线的销售不会有库存问题,只需要保存最终一致性即可

​	2,     mq大量的数据, 它本身其实也是可以当做一个缓存系统来进行使用,如果需要考虑消息的堆积, 那么推荐使用rocketmq,kafka,pulsar



### 思索:

##### 一、对于令牌桶限流,   本质上限流是一种思想, 自身是可以有很多种实现方式

1. ​	redis的限流,后续参照redis教程,   <<redis深度历险>>

2. ​    guava的单机限流, guavalimiter

3. ​     nginx的限流

   和限流类似的问题:  计数

   kafka+ flink实现精确的计数

   redis的INCR实现精确的计数

   redis的hyperLogLOG   实现模糊的计数, 比较适合进行网站的PV和UV的计数



##### 二、RDMA和DMA

​	DMA:   传统的DMA, DMA控制器啦控制硬件IO设备的数据传输, 这也是为什么我们在设置我们系统的并发线程数的时候需要考虑系统的整体IO占比

​	RDMA:  节省内存交换,直接将数据传入对应的存储区



​	当前的MQ吞吐量的瓶颈并不在本机的内存数据交换这块, 目前主要的瓶颈还是在于网络带宽或者磁盘的IO



##### 三,  数据库的数据同步

​	在之前的公司系统中, 不同的系统中数据刷新,对于这类的问题,一定需要注意消息的顺序会不会影响业务



​	

## 二,   MQ的选型

### 	MQ的基本要求

1. 消息的可靠传递：确保不丢消息； 
2. Cluster：支持集群，确保不会因为某个节点宕机导致服务不可用，当然也不能丢消息；
3. 性能：具备足够好的性能，能满足绝大多数场景的性能要求。

### RabbitMQ:

1. 轻量级, 开箱即用
2. 消息的堆积处理较差, 如果消息堆积会导致RabbitMQ的性能急剧下降
3. erlang语言不好扩展



##### 	扩展一下:   延时队列和死信队列

### ROCKETMQ:

1. 低延时

2. 无明显的缺点, 周边组件的适配一般

   

   ##### 扩展一下: 可以实现分布式事务

### KAFKA:

1. ​	之前存在消息丢失的情况,现在已经基本避免
2. ​    因为消息存在批处理的设计, 消息数量没那么多的时候时延反而会更大, 也就是说kafka的实时性会相对比较差(批次的大小是可配的)



​      和大数据相关,或者未来可能使用到大数据的场景,建议使用kafka

​		kafka采用了大量的"批量和异步"的设计, 考虑的是整体吞吐量, 类似于过河坐船(摆渡)

​		rocketmq的延时会更短

