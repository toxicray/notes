# 							MYSQL45讲

## 一、mysql的逻辑架构

#### mysql逻辑架构包括了server层和存储引擎层

##### 1，连接器

​	主要用来处理mysql的连接，鉴权等

##### 2，分析器

​	对sql进行词法分析，语法分析，确认sql是要做什么

##### 3，优化器

​	优化器主要是用来进行执行计划生成，目前的主流是基于成本的执行计划生成（基于规则的目前已经被弃用）

##### 4，执行器

​	调用存储引擎的接口，用来扫描数据，其中examined数据不一定等于扫描行数，因为每次的扫描可能不止一行



## 二、mysql的两大日志模块

#### mysql中两个极其重要的日志模块：binlog和redolog

#### 1，redolog

​	可以理解为一个临时的粉板，属于存储引擎特有的

​	假设有个场景，某个酒馆的生意异常火爆，但是采用人工记账的方式来处理各个人的账务（手工维护一个会员卡余额管理）

​	当某个人的会员情况发生变动的时候我们可能会有以下的两种做法：

1. 直接去翻账本，找到对应的账本，掌柜的根据实际情况进行逻辑计算，然后将数据写入到账本

2. 在一个小板上临时记下变动逻辑，然后在某个空闲的时候进行记录到账本

   

   ​		假如生意异常火爆，那么我们多半会采用第二种去处理这样实现了峰值解耦，能更好的面对峰值处理压力

   如果将以上场景类比一下，小板就是相当于mysql的redolog，掌柜的记忆就相当于内存，账本就是相当于我们的磁盘数据

   ​		小板的大小是基于数据库的设定，是固定大小的文件innodb_log_file_size



日志是循环追加，这样的好处就是避免了磁盘的随机读写，通过check_point和write_pos来管理整个redolog

理论上只要这个日志文件存在，那么数据就可以恢复，也就是数据库的crash_safe能力



​	ps: change_buffer   mysql的数据维护主要是针对于数据页来进行操作的, 更新数据只需要更新change_buffer和写入日志即可,查询数据的时候,将对应的数据合并就可以(脏页)

#### 2，BINLOG

数据库的server层也是有自己的日志体系

该部分的日志主要是重做日志,用于数据库恢复



##### 两个日志的区别：

- redolog是物理日志，记录对某个数据页记录做了什么，binlog是记录逻辑日志，记录原始的逻辑，针对数据行
- redolog是进行循环读写，假如满了会触发数据库的merge操作；binlog是不限制大小，对数据库进行追加读写，写满之后会进行到下一个数据文件



修改某一行数据：

![1620556029718](C:\Users\tytion\AppData\Roaming\Typora\typora-user-images\1620556029718.png)



## 三、MYSQL的事务实现机制

###  mysql的事务隔离级别

​	4个隔离级别，对数据的处理模式是不一样的

##### 实现原理:

本质的实现是基于视图来进行实现,每条数据其实都是有一个版本号,查询的时候我们都只会获取对应版本号范围的数据,这个版本号就是对应着mysql的视图版本

4个隔离级别的区别:

1. 读未提交,每次返回最新的数据即可
2. 读已提交,在sql进行执行的时候建立视图
3. 在事务开启的时候创建视图
4. 串行化,该部分完全规避了并发问题



​	存在的问题就是,假如存在一个长事务,那么对于一条数据,他只要存在某个版本号的视图未结束,那么该数据的undolog就会一直存在,日志文件比较庞大



​		每次创建事务的时候就会生成一个transaction_id, 该数据是严格递增,对某个数据进行修改的时候就会将这个值赋值给这个数据的版本id

​		创建视图的时候本质应该是创建一个数组,记录当前的视图状态



## 四、mysql的锁机制

